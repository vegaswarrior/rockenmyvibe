generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String      @unique(map: "product_slug_idx")
  category    String
  images      String[]
  brand       String
  description String
  stock       Int
  price       Decimal     @default(0) @db.Decimal(12, 2)
  rating      Decimal     @default(0) @db.Decimal(3, 2)
  numReviews  Int         @default(0)
  isFeatured  Boolean     @default(false)
  banner      String?
  printfulProductId String?
  createdAt   DateTime    @default(now()) @db.Timestamp(6)
  OrderItem   OrderItem[]
  Review      Review[]

  variants ProductVariant[]
  productPromos ProductPromo[]
}

model User {
  id                  String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String                           @default("NO_NAME")
  email               String                           @unique(map: "user_email_idx")
  emailVerified       DateTime?                        @db.Timestamp(6)
  image               String?
  password            String?
  role                String                           @default("user")
  shippingAddress     Json?                            @db.Json
  billingAddress      Json?                            @db.Json
  address             Json?                            @db.Json
  paymentMethod       String?
  phoneNumber         String?
  phoneVerified       DateTime?                        @db.Timestamp(6)
  createdAt           DateTime                         @default(now()) @db.Timestamp(6)
  updatedAt           DateTime                         @updatedAt
  account             Account[]
  session             Session[]
  Cart                Cart[]
  Order               Order[]
  Review              Review[]
  savedPaymentMethods SavedPaymentMethod[]
  paymentMethodTokens PaymentMethodVerificationToken[]
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model EmailVerificationToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PasswordResetToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PhoneVerificationToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String   @db.Uuid
  phone    String
  otp      String
  expires  DateTime
  attempts Int      @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([userId])
  @@index([phone])
}

model Cart {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?  @db.Uuid
  sessionCartId String
  items         Json[]   @default([]) @db.Json
  itemsPrice    Decimal  @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2)
  shippingPrice Decimal  @db.Decimal(12, 2)
  taxPrice      Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String      @db.Uuid
  shippingAddress    Json        @db.Json
  paymentMethod      String
  paymentResult      Json?       @db.Json
  itemsPrice         Decimal     @db.Decimal(12, 2)
  shippingPrice      Decimal     @db.Decimal(12, 2)
  taxPrice           Decimal     @db.Decimal(12, 2)
  totalPrice         Decimal     @db.Decimal(12, 2)
  isPaid             Boolean     @default(false)
  paidAt             DateTime?   @db.Timestamp(6)
  isDelivered        Boolean     @default(false)
  deliveredAt        DateTime?   @db.Timestamp(6)
  trackingNumber     String?     @unique
  trackingStatus     String?     @default("pending")
  trackingEvents     Json[]      @default([]) @db.Json
  lastTrackingUpdate DateTime?   @db.Timestamp(6)
  createdAt          DateTime    @default(now()) @db.Timestamp(6)
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderitems         OrderItem[]
}

model OrderItem {
  orderId      String  @db.Uuid
  productId    String  @db.Uuid
  qty          Int
  price        Decimal @db.Decimal(12, 2)
  name         String
  slug         String
  image        String
  variantId    String? @db.Uuid
  variantColor String?
  variantSize  String?
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([orderId, productId], map: "orderitems_orderId_productId_pk")
}

model Color {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  hex       String?
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model Size {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model ProductVariant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @db.Uuid
  sku       String?  @unique
  colorId   String?  @db.Uuid
  sizeId    String?  @db.Uuid
  images    String[] @default([])
  price     Decimal  @db.Decimal(12, 2)
  stock     Int
  printfulExternalId String?
  createdAt DateTime @default(now()) @db.Timestamp(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color   Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)
  size    Size?   @relation(fields: [sizeId], references: [id], onDelete: SetNull)
}

model Review {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @db.Uuid
  productId          String   @db.Uuid
  rating             Int
  title              String
  description        String
  isVerifiedPurchase Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPaymentMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String
  cardholderName        String?
  last4                 String
  expirationDate        String?
  brand                 String?
  billingAddress        Json?    @db.Json
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentMethodId])
}

model PaymentMethodVerificationToken {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @db.Uuid
  paymentMethodId String   @db.Uuid
  token           String   @unique
  expires         DateTime
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Coupon {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])
}

model PromoCode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])

  productPromos ProductPromo[]
}

model ProductPromo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String   @db.Uuid
  promoCodeId String   @db.Uuid

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([productId, promoCodeId])
}

model ShippingSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  baseShippingCost Decimal @db.Decimal(10, 2)
  freeShippingThreshold Decimal @db.Decimal(12, 2)
  uspsIntegrationEnabled Boolean @default(false)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}

model TaxSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taxRate         Decimal  @db.Decimal(5, 2)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}
